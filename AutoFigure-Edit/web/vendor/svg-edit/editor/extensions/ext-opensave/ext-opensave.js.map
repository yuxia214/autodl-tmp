{"version":3,"mappings":"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","names":["fileOpen","fileSave"],"ignoreList":[],"sources":["../../../../src/editor/extensions/ext-opensave/ext-opensave.js"],"sourcesContent":["/* globals seConfirm */\n/**\n * @file ext-opensave.js\n *\n * @license MIT\n *\n * @copyright 2020 OptimistikSAS\n *\n */\n\n/**\n   * @type {module:svgcanvas.EventHandler}\n   * @param {external:Window} wind\n   * @param {module:svgcanvas.SvgCanvas#event:saved} svg The SVG source\n   * @listens module:svgcanvas.SvgCanvas#event:saved\n   * @returns {void}\n   */\nimport { fileOpen, fileSave } from 'browser-fs-access'\n\nconst name = 'opensave'\nlet handle = null\n\nconst loadExtensionTranslation = async function (svgEditor) {\n  let translationModule\n  const lang = svgEditor.configObj.pref('lang')\n  try {\n    translationModule = await import(`./locale/${lang}.js`)\n  } catch (_error) {\n    console.warn(`Missing translation (${lang}) for ${name} - using 'en'`)\n    translationModule = await import('./locale/en.js')\n  }\n  svgEditor.i18next.addResourceBundle(lang, 'translation', translationModule.default, true, true)\n}\n\nexport default {\n  name,\n  async init (_S) {\n    const svgEditor = this\n    const { svgCanvas } = svgEditor\n    const { $id, $click } = svgCanvas\n    await loadExtensionTranslation(svgEditor)\n    /**\n    * @param {Event} e\n    * @returns {void}\n    */\n    const importImage = (e) => {\n      const fileInput = (e.target && e.target.type === 'file') ? e.target : null\n      const resetFileInput = () => {\n        if (fileInput) {\n          fileInput.value = ''\n        }\n      }\n      // only import files\n      if (e.dataTransfer && !e.dataTransfer.types?.includes('Files')) return\n\n      $id('se-prompt-dialog').title = this.i18next.t('notification.loadingImage')\n      $id('se-prompt-dialog').setAttribute('close', false)\n      e.stopPropagation()\n      e.preventDefault()\n      const file = (e.type === 'drop') ? e.dataTransfer.files[0] : e.currentTarget.files[0]\n      if (!file) {\n        $id('se-prompt-dialog').setAttribute('close', true)\n        resetFileInput()\n        return\n      }\n\n      if (!file.type.includes('image')) {\n        resetFileInput()\n        return\n      }\n      // Detected an image\n      // svg handling\n      let reader\n      if (file.type.includes('svg')) {\n        reader = new FileReader()\n        reader.onloadend = (ev) => {\n          // imgImport.shiftKey (shift key pressed or not) will determine if import should preserve dimension)\n          const newElement = this.svgCanvas.importSvgString(ev.target.result, imgImport.shiftKey)\n          this.svgCanvas.alignSelectedElements('m', 'page')\n          this.svgCanvas.alignSelectedElements('c', 'page')\n          // highlight imported element, otherwise we get strange empty selectbox\n          this.svgCanvas.selectOnly([newElement])\n          $id('se-prompt-dialog').setAttribute('close', true)\n          resetFileInput()\n        }\n        reader.readAsText(file)\n      } else {\n        // bitmap handling\n        reader = new FileReader()\n        reader.onloadend = ({ target: { result } }) => {\n          /**\n              * Insert the new image until we know its dimensions.\n              * @param {Float} imageWidth\n              * @param {Float} imageHeight\n              * @returns {void}\n              */\n          const insertNewImage = (imageWidth, imageHeight) => {\n            const newImage = this.svgCanvas.addSVGElementsFromJson({\n              element: 'image',\n              attr: {\n                x: 0,\n                y: 0,\n                width: imageWidth,\n                height: imageHeight,\n                id: this.svgCanvas.getNextId(),\n                style: 'pointer-events:inherit'\n              }\n            })\n            this.svgCanvas.setHref(newImage, result)\n            this.svgCanvas.selectOnly([newImage])\n            this.svgCanvas.alignSelectedElements('m', 'page')\n            this.svgCanvas.alignSelectedElements('c', 'page')\n            this.topPanel.updateContextPanel()\n            $id('se-prompt-dialog').setAttribute('close', true)\n            resetFileInput()\n          }\n          // create dummy img so we know the default dimensions\n          let imgWidth = 100\n          let imgHeight = 100\n          const img = new Image()\n          img.style.opacity = 0\n          img.addEventListener('load', () => {\n            imgWidth = img.offsetWidth || img.naturalWidth || img.width\n            imgHeight = img.offsetHeight || img.naturalHeight || img.height\n            insertNewImage(imgWidth, imgHeight)\n          })\n          img.src = result\n        }\n        reader.readAsDataURL(file)\n      }\n    }\n    // create an input with type file to open the filesystem dialog\n    const imgImport = document.createElement('input')\n    imgImport.type = 'file'\n    imgImport.addEventListener('change', importImage)\n    // dropping a svg file will import it in the svg as well\n    this.workarea.addEventListener('drop', importImage)\n\n    const clickClear = async function () {\n      const [x, y] = svgEditor.configObj.curConfig.dimensions\n      const ok = await seConfirm(svgEditor.i18next.t('notification.QwantToClear'))\n      if (ok === 'Cancel') {\n        return\n      }\n      svgEditor.leftPanel.clickSelect()\n      svgEditor.svgCanvas.clear()\n      svgEditor.svgCanvas.setResolution(x, y)\n      svgEditor.updateCanvas(true)\n      svgEditor.zoomImage()\n      svgEditor.layersPanel.populateLayers()\n      svgEditor.topPanel.updateContextPanel()\n      svgEditor.topPanel.updateTitle('untitled.svg')\n    }\n\n    /**\n     * By default,  this.editor.svgCanvas.open() is a no-op. It is up to an extension\n     *  mechanism (opera widget, etc.) to call `setCustomHandlers()` which\n     *  will make it do something.\n     * @returns {void}\n     */\n    const clickOpen = async function () {\n      // ask user before clearing an unsaved SVG\n      const response = await svgEditor.openPrep()\n      if (response === 'Cancel') { return }\n      svgCanvas.clear()\n      try {\n        const blob = await fileOpen({\n          mimeTypes: ['image/*']\n        })\n        const svgContent = await blob.text()\n        await svgEditor.loadSvgString(svgContent)\n        svgEditor.updateCanvas()\n        handle = blob.handle\n        svgEditor.topPanel.updateTitle(blob.name)\n        svgEditor.svgCanvas.runExtensions('onOpenedDocument', {\n          name: blob.name,\n          lastModified: blob.lastModified,\n          size: blob.size,\n          type: blob.type\n        })\n        svgEditor.layersPanel.populateLayers()\n      } catch (err) {\n        if (err.name !== 'AbortError') {\n          return console.error(err)\n        }\n      }\n    }\n    const b64toBlob = (b64Data, contentType = '', sliceSize = 512) => {\n      const byteCharacters = atob(b64Data)\n      const byteArrays = []\n      for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {\n        const slice = byteCharacters.slice(offset, offset + sliceSize)\n        const byteNumbers = new Array(slice.length)\n        for (let i = 0; i < slice.length; i++) {\n          byteNumbers[i] = slice.charCodeAt(i)\n        }\n        const byteArray = new Uint8Array(byteNumbers)\n        byteArrays.push(byteArray)\n      }\n      const blob = new Blob(byteArrays, { type: contentType })\n      return blob\n    }\n\n    /**\n     *\n     * @returns {void}\n     */\n    const clickSave = async function (type) {\n      const $editorDialog = $id('se-svg-editor-dialog')\n      const editingsource = $editorDialog.getAttribute('dialog') === 'open'\n      if (editingsource) {\n        svgEditor.saveSourceEditor()\n      } else {\n        // In the future, more options can be provided here\n        const saveOpts = {\n          images: svgEditor.configObj.pref('img_save'),\n          round_digits: 2\n        }\n        // remove the selected outline before serializing\n        svgCanvas.clearSelection()\n        // Update save options if provided\n        if (saveOpts) {\n          const saveOptions = svgCanvas.mergeDeep(svgCanvas.getSvgOption(), saveOpts)\n          for (const [key, value] of Object.entries(saveOptions)) {\n            svgCanvas.setSvgOption(key, value)\n          }\n        }\n        svgCanvas.setSvgOption('apply', true)\n\n        // no need for doctype, see https://jwatt.org/svg/authoring/#doctype-declaration\n        const svg = '<?xml version=\"1.0\"?>\\n' + svgCanvas.svgCanvasToString()\n        const b64Data = svgCanvas.encode64(svg)\n        const blob = b64toBlob(b64Data, 'image/svg+xml')\n        try {\n          if (type === 'save' && handle !== null) {\n            const throwIfExistingHandleNotGood = false\n            handle = await fileSave(blob, {\n              fileName: 'untitled.svg',\n              extensions: ['.svg']\n            }, handle, throwIfExistingHandleNotGood)\n          } else {\n            handle = await fileSave(blob, {\n              fileName: svgEditor.title,\n              extensions: ['.svg']\n            })\n          }\n          svgEditor.topPanel.updateTitle(handle.name)\n          svgCanvas.runExtensions('onSavedDocument', {\n            name: handle.name,\n            kind: handle.kind\n          })\n        } catch (err) {\n          if (err.name !== 'AbortError') {\n            return console.error(err)\n          }\n        }\n      }\n    }\n\n    return {\n      name: svgEditor.i18next.t(`${name}:name`),\n      // The callback should be used to load the DOM with the appropriate UI items\n      callback () {\n        const buttonTemplate = `\n        <se-menu-item id=\"tool_clear\" label=\"opensave.new_doc\" shortcut=\"N\" src=\"new.svg\"></se-menu-item>`\n        svgCanvas.insertChildAtIndex($id('main_button'), buttonTemplate, 0)\n        const openButtonTemplate = '<se-menu-item id=\"tool_open\" label=\"opensave.open_image_doc\" src=\"open.svg\"></se-menu-item>'\n        svgCanvas.insertChildAtIndex($id('main_button'), openButtonTemplate, 1)\n        const saveButtonTemplate = '<se-menu-item id=\"tool_save\" label=\"opensave.save_doc\" shortcut=\"S\" src=\"saveImg.svg\"></se-menu-item>'\n        svgCanvas.insertChildAtIndex($id('main_button'), saveButtonTemplate, 2)\n        const saveAsButtonTemplate = '<se-menu-item id=\"tool_save_as\" label=\"opensave.save_as_doc\" src=\"saveImg.svg\"></se-menu-item>'\n        svgCanvas.insertChildAtIndex($id('main_button'), saveAsButtonTemplate, 3)\n        const importButtonTemplate = '<se-menu-item id=\"tool_import\" label=\"tools.import_doc\" src=\"importImg.svg\"></se-menu-item>'\n        svgCanvas.insertChildAtIndex($id('main_button'), importButtonTemplate, 4)\n\n        // handler\n        $click($id('tool_clear'), clickClear.bind(this))\n        $click($id('tool_open'), clickOpen.bind(this))\n        $click($id('tool_save'), clickSave.bind(this, 'save'))\n        $click($id('tool_save_as'), clickSave.bind(this, 'saveas'))\n        // tool_import pressed with shiftKey will not scale the SVG\n        $click($id('tool_import'), (ev) => { imgImport.shiftKey = ev.shiftKey; imgImport.click() })\n      }\n    }\n  }\n}\n"],"file":"ext-opensave.js"}