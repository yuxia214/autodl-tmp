{"version":3,"file":"ext-storage.js","sources":["../../../../src/editor/extensions/ext-storage/ext-storage.js"],"sourcesContent":["/**\n * @file ext-storage.js\n *\n * This extension allows automatic saving of the SVG canvas contents upon\n *  page unload (which can later be automatically retrieved upon future\n *  editor loads).\n *\n *  The functionality was originally part of the SVG Editor, but moved to a\n *  separate extension to make the setting behavior optional, and adapted\n *  to inform the user of its setting of local data.\n *\n * @license MIT\n *\n * @copyright 2010 Brett Zamir\n * @todo Revisit on whether to use `svgEditor.pref` over directly setting\n * `curConfig` in all extensions for a more public API (not only for `extPath`\n * and `imagePath`, but other currently used config in the extensions)\n * @todo We might provide control of storage settings through the UI besides the\n *   initial (or URL-forced) dialog. *\n */\nimport './storageDialog.js'\n\n/**\n * Expire the storage cookie.\n * @returns {void}\n */\nconst removeStoragePrefCookie = () => {\n  expireCookie('svgeditstore')\n}\n/**\n * Set the cookie to expire.\n * @param {string} cookie\n * @returns {void}\n */\nconst expireCookie = cookie => {\n  document.cookie =\n    encodeURIComponent(cookie) + '=; expires=Thu, 01 Jan 1970 00:00:00 GMT'\n}\n\n/**\n * Replace `storagePrompt` parameter within URL.\n * @param {string} val\n * @returns {void}\n * @todo Replace the string manipulation with `searchParams.set`\n */\nconst replaceStoragePrompt = val => {\n  val = val ? 'storagePrompt=' + val : ''\n  const loc = top.location // Allow this to work with the embedded editor as well\n  if (loc.href.includes('storagePrompt=')) {\n    loc.href = loc.href.replace(/([&?])storagePrompt=[^&]*(&?)/, function (\n      n0,\n      n1,\n      amp\n    ) {\n      return (val ? n1 : '') + val + (!val && amp ? n1 : amp || '')\n    })\n  } else {\n    loc.href += (loc.href.includes('?') ? '&' : '?') + val\n  }\n}\n\nexport default {\n  name: 'storage',\n  init () {\n    const svgEditor = this\n    const { svgCanvas, storage } = svgEditor\n\n    // We could empty any already-set data for users when they decline storage,\n    //  but it would be a risk for users who wanted to store but accidentally\n    // said \"no\"; instead, we'll let those who already set it, delete it themselves;\n    // to change, set the \"emptyStorageOnDecline\" config setting to true\n    // in svgedit-config-iife.js/svgedit-config-es.js.\n    const {\n      // When the code in svg-editor.js prevents local storage on load per\n      //  user request, we also prevent storing on unload here so as to\n      //  avoid third-party sites making XSRF requests or providing links\n      // which would cause the user's local storage not to load and then\n      // upon page unload (such as the user closing the window), the storage\n      //  would thereby be set with an empty value, erasing any of the\n      // user's prior work. To change this behavior so that no use of storage\n      // or adding of new storage takes place regardless of settings, set\n      // the \"noStorageOnLoad\" config setting to true in svgedit-config-*.js.\n      noStorageOnLoad,\n      forceStorage,\n      canvasName\n    } = svgEditor.configObj.curConfig\n\n    // LOAD STORAGE CONTENT IF ANY\n    if (\n      storage && // Cookies do not have enough available memory to hold large documents\n      (forceStorage ||\n        (!noStorageOnLoad &&\n          /(?:^|;\\s*)svgeditstore=prefsAndContent/.test(document.cookie)))\n    ) {\n      const key = 'svgedit-' + canvasName\n      const cached = storage.getItem(key)\n      if (cached) {\n        svgEditor.loadFromString(cached)\n        const name = storage.getItem(`title-${key}`) ?? 'untitled.svg'\n        svgEditor.topPanel.updateTitle(name)\n        svgEditor.layersPanel.populateLayers()\n      }\n    }\n\n    // storageDialog added to DOM\n    const storageBox = document.createElement('se-storage-dialog')\n    storageBox.setAttribute('id', 'se-storage-dialog')\n    svgEditor.$container.append(storageBox)\n    storageBox.init(svgEditor.i18next)\n\n    // manage the change in the storageDialog\n\n    storageBox.addEventListener('change', e => {\n      storageBox.setAttribute('dialog', 'close')\n      if (e?.detail?.trigger === 'ok') {\n        if (e?.detail?.select !== 'noPrefsOrContent') {\n          const storagePrompt = new URL(top.location).searchParams.get(\n            'storagePrompt'\n          )\n          document.cookie =\n            'svgeditstore=' +\n            encodeURIComponent(e.detail.select) +\n            '; expires=Fri, 31 Dec 9999 23:59:59 GMT'\n          if (storagePrompt === 'true' && e?.detail?.checkbox) {\n            replaceStoragePrompt()\n            return\n          }\n        } else {\n          removeStoragePrefCookie()\n          if (\n            svgEditor.configObj.curConfig.emptyStorageOnDecline &&\n            e?.detail?.checkbox\n          ) {\n            setSvgContentStorage('')\n            Object.keys(svgEditor.curPrefs).forEach(name => {\n              name = 'svg-edit-' + name\n              if (svgEditor.storage) {\n                svgEditor.storage.removeItem(name)\n              }\n              expireCookie(name)\n            })\n          }\n          if (e?.detail?.select && e?.detail?.checkbox) {\n            replaceStoragePrompt('false')\n            return\n          }\n        }\n      } else if (e?.detail?.trigger === 'cancel') {\n        removeStoragePrefCookie()\n      }\n      setupBeforeUnloadListener()\n      svgEditor.storagePromptState = 'closed'\n      svgEditor.updateCanvas(true)\n    })\n\n    /**\n     * Sets SVG content as a string with \"svgedit-\" and the current\n     *   canvas name as namespace.\n     * @param {string} svgString\n     * @returns {void}\n     */\n    const setSvgContentStorage = svgString => {\n      const name = `svgedit-${svgEditor.configObj.curConfig.canvasName}`\n      if (!svgString) {\n        storage.removeItem(name)\n        storage.removeItem(`${name}-title`)\n      } else {\n        storage.setItem(name, svgString)\n        storage.setItem(`title-${name}`, svgEditor.title)\n      }\n    }\n\n    /**\n     * Listen for unloading: If and only if opted in by the user, set the content\n     *   document and preferences into storage:\n     * 1. Prevent save warnings (since we're automatically saving unsaved\n     *       content into storage)\n     * 2. Use localStorage to set SVG contents (potentially too large to allow in cookies)\n     * 3. Use localStorage (where available) or cookies to set preferences.\n     * @returns {void}\n     */\n    const setupBeforeUnloadListener = () => {\n      window.addEventListener('beforeunload', function () {\n        // Don't save anything unless the user opted in to storage\n        if (\n          !/(?:^|;\\s*)svgeditstore=(?:prefsAndContent|prefsOnly)/.test(\n            document.cookie\n          )\n        ) {\n          return\n        }\n        if (/(?:^|;\\s*)svgeditstore=prefsAndContent/.test(document.cookie)) {\n          setSvgContentStorage(svgCanvas.getSvgString())\n        }\n\n        svgEditor.setConfig({ no_save_warning: true }) // No need for explicit saving at all once storage is on\n\n        const { curPrefs } = svgEditor.configObj\n\n        Object.entries(curPrefs).forEach(([key, val]) => {\n          const store = val !== undefined\n          key = 'svg-edit-' + key\n          if (!store) {\n            return\n          }\n          if (storage) {\n            storage.setItem(key, val)\n          } else if (window.widget) {\n            window.widget.setPreferenceForKey(val, key)\n          } else {\n            val = encodeURIComponent(val)\n            document.cookie =\n              encodeURIComponent(key) +\n              '=' +\n              val +\n              '; expires=Fri, 31 Dec 9999 23:59:59 GMT'\n          }\n        })\n      })\n    }\n\n    let loaded = false\n    return {\n      name: 'storage',\n      callback () {\n        const storagePrompt = new URL(top.location).searchParams.get(\n          'storagePrompt'\n        )\n        // No need to run this one-time dialog again just because the user\n        //   changes the language\n        if (loaded) {\n          return\n        }\n        loaded = true\n\n        // Note that the following can load even if \"noStorageOnLoad\" is\n        //   set to false; to avoid any chance of storage, avoid this\n        //   extension! (and to avoid using any prior storage, set the\n        //   config option \"noStorageOnLoad\" to true).\n        if (\n          !forceStorage &&\n          // If the URL has been explicitly set to always prompt the\n          //  user (e.g., so one can be pointed to a URL where one\n          // can alter one's settings, say to prevent future storage)...\n          (storagePrompt === 'true' ||\n            // ...or...if the URL at least doesn't explicitly prevent a\n            //  storage prompt (as we use for users who\n            // don't want to set cookies at all but who don't want\n            // continual prompts about it)...\n            (storagePrompt !== 'false' &&\n              // ...and this user hasn't previously indicated a desire for storage\n              !/(?:^|;\\s*)svgeditstore=(?:prefsAndContent|prefsOnly)/.test(\n                document.cookie\n              )))\n          // ...then show the storage prompt.\n        ) {\n          const options = Boolean(storage)\n          // Open select-with-checkbox dialog\n          // From svg-editor.js\n          svgEditor.storagePromptState = 'waiting'\n          const $storageDialog = document.getElementById('se-storage-dialog')\n          $storageDialog.setAttribute('dialog', 'open')\n          $storageDialog.setAttribute('storage', options)\n        } else if (!noStorageOnLoad || forceStorage) {\n          setupBeforeUnloadListener()\n        }\n      }\n    }\n  }\n}\n"],"names":[],"mappings":"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"}